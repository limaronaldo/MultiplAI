# Integrations Module Instructions

This directory contains external service integrations: LLM providers, GitHub, Linear, and database.

## LLM Providers

| File | Provider | Models |
|------|----------|--------|
| `llm.ts` | Router | Routes to correct provider |
| `anthropic.ts` | Anthropic | claude-sonnet-4-5-*, claude-opus-4-5-* |
| `openai.ts` | OpenAI Chat | Legacy GPT models |
| `openai-direct.ts` | OpenAI Responses | gpt-5.1-codex-max, gpt-5.1-codex-mini |
| `openrouter.ts` | OpenRouter | x-ai/grok-*, google/gemini-* |

### LLM Router

Always use the router, never call providers directly:

```typescript
import { createLLMRouter } from "./llm";

const llm = createLLMRouter();
const response = await llm.chat(prompt, {
  model: "gpt-5.1-codex-max",
  reasoningEffort: "high",
});
```

### Provider Routing Logic

```typescript
// Model → Provider mapping
claude-* → AnthropicClient
gpt-5.1-codex-* → OpenAIDirectClient (Responses API)
gpt-4*, gpt-3.5* → OpenAIClient (Chat API)
x-ai/*, google/* → OpenRouterClient
```

### OpenAI Responses API (openai-direct.ts)

Used for GPT-5.1 Codex models with reasoning:

```typescript
// Request structure
POST /v1/responses
{
  model: "gpt-5.1-codex-max",
  input: prompt,
  reasoning: { effort: "high" | "medium" | "low" },
  text: { verbosity: "concise" }
}

// Response extraction
response.output_text // Primary field
response.output[0].content[0].text // Fallback
```

**Important:** Response may return objects, not strings. Handle in `parseJSON()`.

## GitHub Integration (github.ts)

Octokit wrapper with diff operations:

```typescript
import { GitHubClient } from "./github";

const gh = new GitHubClient(token, owner, repo);

// File operations
await gh.getFileContent(path, branch);
await gh.createBranch(baseBranch, newBranch);
await gh.applyDiff(diff, branch, commitMessage);
await gh.createPR(title, body, head, base);

// Issue operations
await gh.getIssue(issueNumber);
await gh.addIssueComment(issueNumber, body);
```

### Diff Application

The `applyDiff()` method:
1. Parses unified diff format
2. Fixes hunk line counts (LLMs often get these wrong)
3. Applies changes via GitHub Contents API
4. Commits atomically

## Database (db.ts)

Task and event CRUD operations:

```typescript
import { getTask, updateTask, addTaskEvent, listPendingTasks } from "./db";

// Task operations
const task = await getTask(taskId);
await updateTask(taskId, { status: "CODING_DONE", currentDiff: diff });

// Event logging
await addTaskEvent(taskId, "AGENT_OUTPUT", { agent: "coder", output });

// Queries
const pending = await listPendingTasks();
const byIssue = await getTaskByIssueNumber(owner, repo, issueNumber);
```

## Linear Integration (linear.ts)

Two-way sync with Linear:

```typescript
import { LinearClient } from "./linear";

const linear = new LinearClient(apiKey);

// Create issue
await linear.createIssue({ title, description, teamId });

// Update status
await linear.updateIssueStatus(issueId, "In Progress");

// Link to GitHub
await linear.attachGitHubPR(issueId, prUrl);
```

## Error Handling

All integrations should:

1. **Retry with exponential backoff** - transient failures are common
2. **Log detailed errors** - include request context
3. **Throw descriptive errors** - help debugging
4. **Respect rate limits** - especially GitHub API

```typescript
async function withRetry<T>(fn: () => Promise<T>, maxRetries = 3): Promise<T> {
  for (let attempt = 0; attempt < maxRetries; attempt++) {
    try {
      return await fn();
    } catch (error) {
      if (attempt === maxRetries - 1) throw error;
      await sleep(Math.pow(2, attempt) * 1000);
    }
  }
  throw new Error("Unreachable");
}
```
