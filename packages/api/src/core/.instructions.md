# Core Module Instructions

This directory contains the central orchestration logic, state machine, and supporting systems for AutoDev.

## Key Files

| File | Purpose |
|------|---------|
| `orchestrator.ts` | Main processing loop - coordinates agents |
| `state-machine.ts` | Task state transitions and validation |
| `types.ts` | Zod schemas and TypeScript interfaces |
| `model-selection.ts` | Effort-based model routing |
| `patch-formats.ts` | Unified diff and Codex-Max conversion |
| `multi-runner.ts` | Parallel agent execution |
| `consensus.ts` | Multi-agent voting logic |
| `diff-validator.ts` | Validate diffs before applying |
| `job-runner.ts` | Batch job processing |
| `logger.ts` | Structured logging |

## State Machine

Tasks flow through these states:

```
NEW → PLANNING → PLANNING_DONE → CODING → CODING_DONE → TESTING
                                                           ↓
                                    TESTS_PASSED → REVIEWING → PR_CREATED → WAITING_HUMAN
                                    TESTS_FAILED → FIXING → CODING_DONE (max 3 retries)
```

### Adding a New State

1. Add to `TaskStatus` in `types.ts`:
   ```typescript
   export const TaskStatus = z.enum([...existing, "NEW_STATE"]);
   ```

2. Add transitions in `state-machine.ts`:
   ```typescript
   NEW_STATE: ["NEXT_STATE", "ALTERNATIVE_STATE"],
   ```

3. Add handler in `orchestrator.ts`:
   ```typescript
   case "NEW_STATE":
     await this.handleNewState(task);
     break;
   ```

## Model Selection

The `model-selection.ts` file controls which models are used:

```typescript
// Effort-based selection for XS tasks
getModelForEffort(effort: "low" | "medium" | "high", attempt: number)

// Returns model config based on effort and retry count
// attempt 0: effort-based model
// attempt 1: escalate to xhigh
// attempt 2+: fallback to Claude Opus
```

**Never change models without user approval.**

## Patch Formats

AutoDev supports multiple diff formats with auto-conversion:

| Format | Detection | Source |
|--------|-----------|--------|
| Unified diff | `diff --git` or `---` | Standard git |
| Codex-Max | `*** Begin Patch` | GPT-5.1-Codex-Max |

Use `normalizePatch()` to convert any format to unified diff.

## Memory Systems

Located in `memory/` subdirectory:

| System | Scope | Storage |
|--------|-------|---------|
| StaticMemory | Per-repo | File/DB |
| SessionMemory | Per-task | Database |
| LearningMemory | Cross-task | Database with decay |

The `MemoryManager` compiles context per agent call - context is computed, not accumulated.

## Coding Standards

1. **Use Zod for all schemas** - no raw TypeScript types for external data
2. **Log all state transitions** - use `logger.ts`
3. **Validate inputs** - never trust LLM output without validation
4. **Handle retries** - max 3 attempts before failing
5. **Preserve audit trail** - all changes logged to task_events
